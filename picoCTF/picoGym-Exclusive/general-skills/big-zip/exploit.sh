#!/bin/bash

# Validate the URL format
if ! [[ "$1" =~ ^https:\/\/([A-Za-z0-9-]+\.)*picoctf\.net\/* ]]; then
    echo "Error: please provide a valid URL as an argument."
    echo "Usage: $0 <URL>"
    exit 1
fi

URL=$1

get_flag() {
	# Download the big-zip-files.zip
    wget -q "$URL" -O big-zip-files.zip
    if [ $? -ne 0 ]; then
        echo "Error: Failed to download file."
        exit 1
    fi

    # Unzip the downloaded file
    unzip -q big-zip-files.zip
    if [ $? -ne 0 ]; then
        echo "Error: Failed to unzip file."
        exit 1
    fi

    # Check if the directory 'drop-in' exists after unzipping
    if [ ! -d "big-zip-files" ]; then
        echo "Error: 'big-zip-files' directory not found."
        exit 1
    fi

    # Extract the flag from the git show output
    grep -RoE 'picoCTF{.*?}' big-zip-files | cut -d ':' -f 2
    if [ $? -ne 0 ]; then
        echo "Error: Failed to extract flag."
        exit 1
    fi
}

# Call the function and store the flag
flag=$(get_flag)

# Check if the flag is found and print it
if [ -z "$flag" ]; then
    echo "Error: Flag not found."
else
    echo "Flag: $flag"
    rm -rf big-zip-files && rm big-zip-files.zip
fi