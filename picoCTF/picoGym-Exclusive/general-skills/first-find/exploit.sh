#!/bin/bash

# Validate the URL format
if ! [[ "$1" =~ ^https:\/\/([A-Za-z0-9-]+\.)*picoctf\.net\/* ]]; then
    echo "Error: please provide a valid URL as an argument."
    echo "Usage: $0 <URL>"
    exit 1
fi

URL=$1

get_flag() {
	# Download the files.zip
    wget -q "$URL" -O files.zip
    if [ $? -ne 0 ]; then
        echo "Error: Failed to download file."
        exit 1
    fi

    # Unzip the downloaded file
    unzip -q files.zip
    if [ $? -ne 0 ]; then
        echo "Error: Failed to unzip file."
        exit 1
    fi

    # Check if the directory 'files' exists after unzipping
    if [ ! -d "files" ]; then
        echo "Error: 'files' directory not found."
        exit 1
    fi

    # Extract the flag from the git show output
    grep -RoE 'picoCTF{.*?}' files | cut -d ':' -f 2
    if [ $? -ne 0 ]; then
        echo "Error: Failed to extract flag."
        exit 1
    fi
}

# Call the function and store the flag
flag=$(get_flag)

# Check if the flag is found and print it
if [ -z "$flag" ]; then
    echo "Error: Flag not found."
else
    echo "Flag: $flag"
    rm -rf files && rm files.zip
fi